<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Nepal Redistricting Simulator — Fair vs Reality</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Sora:wght@300;400;600;700&family=JetBrains+Mono:wght@300;400;600&display=swap" rel="stylesheet"/>
<style>
:root {
  --bg: #06080f;
  --bg2: #0d1020;
  --bg3: #141828;
  --border: rgba(255,255,255,0.07);
  --border2: rgba(255,255,255,0.12);
  --text: #c8cfe0;
  --text-dim: #5a6380;
  --bright: #ffffff;
  --gain: #00e5a0;
  --loss: #ff4060;
  --neutral: #4a5580;
  --accent: #f5c842;
  --pulse: #ff4060;
  --font-head: 'Bebas Neue', sans-serif;
  --font-body: 'Sora', sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
}

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}

html{scroll-behavior:smooth;}

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-body);
  font-size: 13px;
  min-height: 100vh;
  overflow-x: hidden;
}

/* Scanline overlay */
body::after {
  content:'';
  position:fixed;inset:0;
  background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px);
  pointer-events:none;z-index:1000;
}

/* Grid bg */
body::before {
  content:'';
  position:fixed;inset:0;
  background-image:
    linear-gradient(rgba(245,200,66,0.015) 1px, transparent 1px),
    linear-gradient(90deg, rgba(245,200,66,0.015) 1px, transparent 1px);
  background-size: 60px 60px;
  pointer-events:none;z-index:0;
}

/* === HEADER === */
header {
  position:relative;z-index:10;
  border-bottom: 1px solid var(--border);
  padding: 0 40px;
  display:flex;align-items:stretch;justify-content:space-between;
  background: linear-gradient(180deg, rgba(245,200,66,0.03) 0%, transparent 100%);
}

.header-left {
  padding: 24px 0;
}

.eyebrow {
  font-family:var(--font-mono);
  font-size:9px;letter-spacing:0.3em;
  color:var(--accent);text-transform:uppercase;
  display:block;margin-bottom:8px;
}

header h1 {
  font-family:var(--font-head);
  font-size:clamp(32px,5vw,64px);
  letter-spacing:0.02em;
  color:var(--bright);
  line-height:1;
}

header h1 span { color:var(--accent); }

.header-sub {
  font-family:var(--font-body);
  font-size:11px;color:var(--text-dim);
  margin-top:6px;letter-spacing:0.05em;
}

/* Heartbeat / unrepresented counter */
.pulse-counter {
  display:flex;flex-direction:column;align-items:flex-end;justify-content:center;
  padding: 20px 0 20px 40px;
  border-left: 1px solid var(--border);
  margin-left:40px;
}

.pulse-label {
  font-family:var(--font-mono);font-size:8px;
  letter-spacing:0.25em;color:var(--loss);
  text-transform:uppercase;margin-bottom:4px;
}

.pulse-number {
  font-family:var(--font-head);
  font-size:clamp(28px,4vw,52px);
  color:var(--loss);
  line-height:1;
  animation: heartbeat 1.4s ease-in-out infinite;
}

@keyframes heartbeat {
  0%,100%{text-shadow:0 0 20px rgba(255,64,96,0.4);}
  14%{text-shadow:0 0 60px rgba(255,64,96,1),0 0 20px rgba(255,64,96,0.8);}
  28%{text-shadow:0 0 20px rgba(255,64,96,0.4);}
  42%{text-shadow:0 0 50px rgba(255,64,96,0.9);}
  70%{text-shadow:0 0 20px rgba(255,64,96,0.4);}
}

.pulse-sub {
  font-family:var(--font-mono);font-size:9px;
  color:rgba(255,64,96,0.5);margin-top:4px;
  text-align:right;
}

/* Heartbeat line */
.pulse-line {
  width:180px;height:40px;margin-top:8px;
}

/* === MAIN LAYOUT === */
main {
  position:relative;z-index:5;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:0;
  min-height:calc(100vh - 130px);
}

/* Section headers */
.section-header {
  padding:16px 32px;
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:12px;
}

.section-tag {
  font-family:var(--font-head);
  font-size:22px;letter-spacing:0.05em;
  color:var(--bright);
}

.section-badge {
  font-family:var(--font-mono);
  font-size:8px;letter-spacing:0.2em;
  padding:3px 8px;border-radius:2px;
  text-transform:uppercase;
}

.badge-current { background:rgba(90,99,128,0.3);color:var(--text-dim);border:1px solid var(--neutral); }
.badge-sim { background:rgba(245,200,66,0.15);color:var(--accent);border:1px solid rgba(245,200,66,0.3); }

/* === LEFT PANEL: CURRENT REALITY === */
.panel-left {
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;
}

.panel-right {
  display:flex;flex-direction:column;
}

/* Province cards area */
.cards-area {
  padding:24px 28px;
  flex:1;
  overflow-y:auto;
  display:flex;flex-direction:column;gap:10px;
}

.cards-area::-webkit-scrollbar{width:3px;}
.cards-area::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* Province card */
.province-card {
  background:var(--bg2);
  border:1px solid var(--border);
  border-radius:3px;
  padding:14px 16px;
  position:relative;overflow:hidden;
  transition:border-color 0.3s;
}

.province-card::before {
  content:'';
  position:absolute;top:0;left:0;bottom:0;width:3px;
  background:var(--card-color);
  transition:width 0.3s;
}

.province-card:hover { border-color:var(--border2); }
.province-card:hover::before { width:5px; }

.pc-top {
  display:flex;justify-content:space-between;align-items:flex-start;
  margin-bottom:10px;
}

.pc-name {
  font-family:var(--font-body);font-weight:700;
  font-size:13px;color:var(--bright);
}

.pc-region {
  font-family:var(--font-mono);font-size:8px;
  color:var(--text-dim);margin-top:2px;letter-spacing:0.1em;
}

.pc-seats {
  font-family:var(--font-head);
  font-size:32px;line-height:1;
  color:var(--card-color);
  text-align:right;
}

.pc-seats-label {
  font-family:var(--font-mono);font-size:7px;
  color:var(--text-dim);text-transform:uppercase;
  letter-spacing:0.1em;text-align:right;
}

/* Seat dot visualizer */
.seat-dots {
  display:flex;flex-wrap:wrap;gap:3px;
  margin-bottom:10px;
}

.seat-dot {
  width:8px;height:8px;border-radius:50%;
  background:var(--card-color);
  opacity:0.7;
  transition:all 0.4s ease;
}

.seat-dot.phantom {
  opacity:0.2;border:1px solid var(--card-color);
  background:transparent;
}

.seat-dot.gained {
  background:var(--gain);
  animation:popIn 0.3s ease both;
}

.seat-dot.lost {
  background:var(--loss);
  animation:fadeOut 0.3s ease both;
}

@keyframes popIn {
  from{transform:scale(0);opacity:0;}
  to{transform:scale(1);opacity:0.7;}
}

@keyframes fadeOut {
  from{opacity:0.7;}
  to{opacity:0.15;}
}

.pc-stats {
  display:flex;gap:16px;
}

.pc-stat {
  display:flex;flex-direction:column;gap:1px;
}

.pc-stat-val {
  font-family:var(--font-mono);font-size:11px;
  color:var(--text);font-weight:600;
}

.pc-stat-lbl {
  font-family:var(--font-mono);font-size:8px;
  color:var(--text-dim);text-transform:uppercase;
  letter-spacing:0.07em;
}

/* Delta badge */
.delta-badge {
  position:absolute;top:12px;right:16px;
  font-family:var(--font-head);font-size:20px;
  padding:2px 8px;border-radius:2px;
  transition:all 0.4s ease;
  opacity:0;
}

.delta-badge.show{opacity:1;}
.delta-badge.gain{background:rgba(0,229,160,0.15);color:var(--gain);border:1px solid rgba(0,229,160,0.3);}
.delta-badge.loss{background:rgba(255,64,96,0.15);color:var(--loss);border:1px solid rgba(255,64,96,0.3);}
.delta-badge.zero{background:rgba(90,99,128,0.15);color:var(--text-dim);border:1px solid var(--border);}

/* === RIGHT PANEL: SIMULATOR === */
.sim-controls {
  padding:20px 28px;
  border-bottom:1px solid var(--border);
  background:var(--bg2);
}

.sim-title {
  font-family:var(--font-mono);font-size:9px;
  letter-spacing:0.2em;color:var(--accent);
  text-transform:uppercase;margin-bottom:12px;
}

.weight-sliders {
  display:grid;grid-template-columns:1fr 1fr;gap:16px;
  margin-bottom:16px;
}

.slider-group {
  display:flex;flex-direction:column;gap:6px;
}

.sg-label {
  display:flex;justify-content:space-between;
  font-family:var(--font-mono);font-size:9px;
  text-transform:uppercase;letter-spacing:0.1em;
}

.sg-name{color:var(--text-dim);}
.sg-val{color:var(--accent);font-weight:600;}

input[type=range] {
  -webkit-appearance:none;
  width:100%;height:3px;
  border-radius:2px;outline:none;cursor:pointer;
}

#popWeight { background:linear-gradient(90deg,#1a3a8a,var(--accent)); }
#geoWeight { background:linear-gradient(90deg,#1a3a8a,#059669); }
#minGuarantee { background:linear-gradient(90deg,#1a3a8a,#9333ea); }
#teraiBias { background:linear-gradient(90deg,#1a3a8a,var(--loss)); }

input[type=range]::-webkit-slider-thumb {
  -webkit-appearance:none;
  width:16px;height:16px;
  background:var(--bright);border-radius:50%;
  border:3px solid var(--bg);
  box-shadow:0 2px 8px rgba(0,0,0,0.5);
  transition:transform 0.15s;
}
input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.3);}

.sim-presets {
  display:flex;gap:8px;flex-wrap:wrap;
}

.preset-btn {
  font-family:var(--font-mono);font-size:9px;
  letter-spacing:0.1em;text-transform:uppercase;
  padding:5px 12px;
  background:transparent;
  border:1px solid var(--border2);
  color:var(--text-dim);cursor:pointer;
  border-radius:2px;
  transition:all 0.2s;
}

.preset-btn:hover,
.preset-btn.active {
  background:rgba(245,200,66,0.1);
  border-color:rgba(245,200,66,0.4);
  color:var(--accent);
}

/* Summary bar */
.summary-bar {
  padding:14px 28px;
  border-bottom:1px solid var(--border);
  display:flex;gap:0;
  background:linear-gradient(90deg,rgba(0,229,160,0.05),transparent 50%,rgba(255,64,96,0.05));
}

.sum-block {
  flex:1;text-align:center;
  border-right:1px solid var(--border);
  padding:0 12px;
}
.sum-block:last-child{border-right:none;}

.sum-val {
  font-family:var(--font-head);font-size:28px;
  line-height:1;transition:color 0.4s,transform 0.4s;
  display:inline-block;
}

.sum-lbl {
  font-family:var(--font-mono);font-size:8px;
  text-transform:uppercase;letter-spacing:0.1em;
  color:var(--text-dim);margin-top:3px;
}

/* Fairness meter */
.fairness-section {
  padding:16px 28px;
  border-bottom:1px solid var(--border);
}

.fairness-label {
  font-family:var(--font-mono);font-size:9px;
  letter-spacing:0.15em;color:var(--text-dim);
  text-transform:uppercase;margin-bottom:8px;
  display:flex;justify-content:space-between;
}

.fairness-score {
  font-family:var(--font-head);font-size:18px;
  transition:color 0.5s;
}

.fairness-track {
  width:100%;height:10px;
  background:var(--bg3);border-radius:5px;
  overflow:hidden;position:relative;
}

.fairness-fill {
  height:100%;border-radius:5px;
  background:linear-gradient(90deg,var(--loss),var(--accent),var(--gain));
  transition:width 0.6s cubic-bezier(0.4,0,0.2,1);
}

.fairness-marker {
  position:absolute;top:0;bottom:0;width:2px;
  background:rgba(255,255,255,0.3);
}

/* Sim cards area */
.sim-cards {
  padding:16px 28px 24px;
  flex:1;overflow-y:auto;
  display:flex;flex-direction:column;gap:10px;
}

.sim-cards::-webkit-scrollbar{width:3px;}
.sim-cards::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* Sim province card */
.sim-card {
  background:var(--bg2);border:1px solid var(--border);
  border-radius:3px;padding:12px 14px;
  position:relative;overflow:hidden;
  transition:all 0.3s;
}

.sim-card.gaining { border-color:rgba(0,229,160,0.3); }
.sim-card.losing { border-color:rgba(255,64,96,0.3); }

.sim-card-top {
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:8px;
}

.sim-pname {
  font-weight:600;font-size:12px;color:var(--bright);
}

.sim-change {
  font-family:var(--font-head);font-size:18px;
  transition:all 0.4s;
}

.sim-bars {
  display:flex;gap:4px;align-items:flex-end;
  height:28px;
}

.sim-bar-current, .sim-bar-fair {
  border-radius:2px 2px 0 0;
  min-width:8px;
  transition:height 0.5s cubic-bezier(0.4,0,0.2,1);
  position:relative;
}

.sim-bar-current {
  background:var(--neutral);flex:1;
}

.sim-bar-fair {
  background:var(--accent);opacity:0.8;flex:1;
  border:1px solid rgba(245,200,66,0.5);
}

.sim-bar-labels {
  display:flex;gap:4px;
  font-family:var(--font-mono);font-size:8px;
  color:var(--text-dim);margin-top:3px;
}

.sbl-current{color:var(--neutral);}
.sbl-fair{color:var(--accent);}

.below-threshold {
  position:absolute;inset:0;
  display:flex;align-items:center;justify-content:center;
  background:rgba(255,64,96,0.1);
  border:1px dashed rgba(255,64,96,0.4);
  font-family:var(--font-mono);font-size:9px;
  color:var(--loss);letter-spacing:0.1em;
  opacity:0;transition:opacity 0.3s;
  pointer-events:none;
}

.sim-card.would-drop .below-threshold{opacity:1;}

/* Unrepresented ticker detail */
.unrep-detail {
  padding:12px 28px;
  border-top:1px solid var(--border);
  background:rgba(255,64,96,0.04);
  display:flex;gap:20px;align-items:center;
}

.unrep-detail-num {
  font-family:var(--font-head);font-size:22px;color:var(--loss);
  white-space:nowrap;
}

.unrep-detail-text {
  font-family:var(--font-mono);font-size:9px;color:rgba(255,64,96,0.5);
  line-height:1.6;letter-spacing:0.04em;
}

/* === BOTTOM STRIP === */
.bottom-strip {
  position:relative;z-index:5;
  border-top:1px solid var(--border);
  padding:12px 40px;
  display:flex;align-items:center;gap:32px;
  background:var(--bg2);
}

.bs-fact {
  font-family:var(--font-mono);font-size:10px;
  color:var(--text-dim);flex:1;
  transition:opacity 0.4s;
}

.bs-fact strong{color:var(--accent);}

.bs-total {
  font-family:var(--font-mono);font-size:9px;
  color:var(--text-dim);white-space:nowrap;
  text-align:right;
}

.bs-total span{color:var(--bright);}

/* Legend */
.legend {
  display:flex;gap:16px;align-items:center;
  font-family:var(--font-mono);font-size:8px;
  text-transform:uppercase;letter-spacing:0.1em;
}

.leg-dot {
  width:8px;height:8px;border-radius:50%;
  display:inline-block;margin-right:4px;
}

/* Transitions for numbers */
.counting { animation: countBounce 0.3s ease; }
@keyframes countBounce {
  0%{transform:scale(1.2);}
  100%{transform:scale(1);}
}

/* Scrollbar */
::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* Responsive */
@media(max-width:900px){
  main{grid-template-columns:1fr;}
  .panel-left{border-right:none;border-bottom:1px solid var(--border);}
  .weight-sliders{grid-template-columns:1fr;}
  header{flex-direction:column;padding:20px;}
  .pulse-counter{border-left:none;border-top:1px solid var(--border);margin-left:0;padding:16px 0 0;align-items:flex-start;}
}

/* Fade in */
@keyframes fadeUp {
  from{opacity:0;transform:translateY(16px);}
  to{opacity:1;transform:translateY(0);}
}

.province-card, .sim-card {
  animation:fadeUp 0.4s ease both;
}
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="header-left">
    <span class="eyebrow">Nepal Electoral Reform · Interactive Simulator · 2082</span>
    <h1>FAIR <span>VS</span> REALITY</h1>
    <div class="header-sub">Drag the sliders to redistribute 165 parliamentary seats by population — watch democracy recalibrate in real time</div>
  </div>
  <div class="pulse-counter">
    <div class="pulse-label">⚡ Diluted Terai Voters</div>
    <div class="pulse-number" id="unrepCount">0</div>
    <div class="pulse-sub">voters whose weight is below national average</div>
    <svg class="pulse-line" viewBox="0 0 180 40" id="heartbeatSVG">
      <polyline id="heartbeatLine" points="" fill="none" stroke="#ff4060" stroke-width="1.5" opacity="0.6"/>
    </svg>
  </div>
</header>

<!-- MAIN -->
<main>

  <!-- LEFT: CURRENT REALITY -->
  <div class="panel-left">
    <div class="section-header">
      <div class="section-tag">CURRENT REALITY</div>
      <span class="section-badge badge-current">As of 2079 Election</span>
      <span style="font-family:var(--font-mono);font-size:9px;color:var(--text-dim);margin-left:auto;">Based on 2068 Census · 165 total seats</span>
    </div>
    <div class="cards-area" id="currentCards"></div>
  </div>

  <!-- RIGHT: SIMULATOR -->
  <div class="panel-right">
    <div class="section-header">
      <div class="section-tag">REDISTRICTING SIMULATOR</div>
      <span class="section-badge badge-sim">Interactive</span>
    </div>

    <!-- Controls -->
    <div class="sim-controls">
      <div class="sim-title">Adjust Weighting Formula</div>
      <div class="weight-sliders">
        <div class="slider-group">
          <div class="sg-label">
            <span class="sg-name">Population Weight</span>
            <span class="sg-val" id="popVal">90%</span>
          </div>
          <input type="range" id="popWeight" min="50" max="100" value="90" step="5"/>
        </div>
        <div class="slider-group">
          <div class="sg-label">
            <span class="sg-name">Geography Weight</span>
            <span class="sg-val" id="geoVal">10%</span>
          </div>
          <input type="range" id="geoWeight" min="0" max="50" value="10" step="5"/>
        </div>
        <div class="slider-group">
          <div class="sg-label">
            <span class="sg-name">Min Seats / District</span>
            <span class="sg-val" id="minVal">1</span>
          </div>
          <input type="range" id="minGuarantee" min="0" max="3" value="1" step="1"/>
        </div>
        <div class="slider-group">
          <div class="sg-label">
            <span class="sg-name">Terai Population Boost</span>
            <span class="sg-val" id="teraiBiasVal">0%</span>
          </div>
          <input type="range" id="teraiBias" min="0" max="30" value="0" step="5"/>
        </div>
      </div>
      <div class="sim-presets">
        <button class="preset-btn active" onclick="applyPreset('current')">Current Formula</button>
        <button class="preset-btn" onclick="applyPreset('pure_pop')">Pure Population</button>
        <button class="preset-btn" onclick="applyPreset('madhesh_demand')">Madhesh Demand</button>
        <button class="preset-btn" onclick="applyPreset('geo_heavy')">Geography Heavy</button>
        <button class="preset-btn" onclick="applyPreset('voter_based')">Voter-Based</button>
      </div>
    </div>

    <!-- Summary numbers -->
    <div class="summary-bar">
      <div class="sum-block">
        <div class="sum-val" id="sumGained" style="color:var(--gain)">+0</div>
        <div class="sum-lbl">Seats Gained<br/>(Terai/Hills)</div>
      </div>
      <div class="sum-block">
        <div class="sum-val" id="sumLost" style="color:var(--loss)">−0</div>
        <div class="sum-lbl">Seats Lost<br/>(Mountains)</div>
      </div>
      <div class="sum-block">
        <div class="sum-val" id="sumDrop" style="color:var(--accent)">0</div>
        <div class="sum-lbl">Districts Below<br/>1-Seat Threshold</div>
      </div>
      <div class="sum-block">
        <div class="sum-val" id="sumFair" style="color:var(--bright)">42%</div>
        <div class="sum-lbl">Fairness<br/>Index</div>
      </div>
    </div>

    <!-- Fairness meter -->
    <div class="fairness-section">
      <div class="fairness-label">
        <span>Representation Fairness Index</span>
        <span class="fairness-score" id="fairnessScore">42%</span>
      </div>
      <div class="fairness-track">
        <div class="fairness-fill" id="fairnessFill" style="width:42%"></div>
        <div class="fairness-marker" style="left:42%"></div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:4px;font-family:var(--font-mono);font-size:8px;color:var(--text-dim);">
        <span style="color:var(--loss)">Highly Unequal</span>
        <span>Current (42%)</span>
        <span style="color:var(--gain)">Perfect Democracy</span>
      </div>
    </div>

    <!-- Sim province cards -->
    <div class="sim-cards" id="simCards"></div>

    <!-- Unrepresented detail -->
    <div class="unrep-detail">
      <div class="unrep-detail-num" id="unrepDetail">—</div>
      <div class="unrep-detail-text" id="unrepText">
        Terai voters whose electoral weight is below the national average.<br/>
        Adjust sliders to see how redistricting reduces this number.
      </div>
    </div>
  </div>

</main>

<!-- BOTTOM STRIP -->
<div class="bottom-strip">
  <div class="legend">
    <span><span class="leg-dot" style="background:var(--neutral)"></span>Current seats</span>
    <span><span class="leg-dot" style="background:var(--accent)"></span>Simulated seats</span>
    <span><span class="leg-dot" style="background:var(--gain)"></span>Gaining</span>
    <span><span class="leg-dot" style="background:var(--loss)"></span>Losing</span>
  </div>
  <div class="bs-fact" id="bottomFact">Loading facts...</div>
  <div class="bs-total">Total Seats: <span>165</span> · Total Voters 2082: <span>18,903,689</span></div>
</div>

<script>
// ======================================================
//  NEPAL REDISTRICTING SIMULATOR — DATA & LOGIC
// ======================================================

const TOTAL_SEATS = 165;
const TOTAL_VOTERS_2082 = 18903689;
const TOTAL_AREA = 147181; // km²

const provinces = [
  {
    id:'koshi', name:'Koshi', region:'East',
    voters2082: 3574390, voters2079: 3396865,
    area: 25905, currentSeats: 28,
    color:'#3b82f6', isTerai:false, isMountain:false,
    avgVoters: 127654,
    notableConst: 'Jhapa-5 (163,379 voters)',
  },
  {
    id:'madhesh', name:'Madhesh', region:'Terai',
    voters2082: 3636414, voters2079: 3346628,
    area: 9661, currentSeats: 32,
    color:'#a855f7', isTerai:true, isMountain:false,
    avgVoters: 113638,
    notableConst: 'Sarlahi-4 (121,000 voters)',
  },
  {
    id:'bagmati', name:'Bagmati', region:'Hills/Valley',
    voters2082: 3652390, voters2079: 3479492,
    area: 20300, currentSeats: 33,
    color:'#10b981', isTerai:false, isMountain:false,
    avgVoters: 110678,
    notableConst: 'Ramechhap (187,952 voters)',
  },
  {
    id:'gandaki', name:'Gandaki', region:'Hills/Mountain',
    voters2082: 1670065, voters2079: 1619581,
    area: 21504, currentSeats: 18,
    color:'#f59e0b', isTerai:false, isMountain:true,
    avgVoters: 103892,
    notableConst: 'Manang (7,000 voters)',
  },
  {
    id:'lumbini', name:'Lumbini', region:'Hills/Terai',
    voters2082: 3346660, voters2079: 3249637,
    area: 22288, currentSeats: 26,
    color:'#ef4444', isTerai:false, isMountain:false,
    avgVoters: 128717,
    notableConst: 'Arghakhanchi (179,652 voters)',
  },
  {
    id:'karnali', name:'Karnali', region:'Mountain',
    voters2082: 1039250, voters2079: 1008403,
    area: 27984, currentSeats: 12,
    color:'#06b6d4', isTerai:false, isMountain:true,
    avgVoters: 86438,
    notableConst: 'Dolpa (24,115 voters)',
  },
  {
    id:'sudurpashchim', name:'Sudurpashchim', region:'Hills/Mountain',
    voters2082: 1796660, voters2079: 1655004,
    area: 19539, currentSeats: 16,
    color:'#84cc16', isTerai:false, isMountain:true,
    avgVoters: 109291,
    notableConst: 'Humla (34,372 voters)',
  },
];

// District counts per province for min-guarantee
const districtCount = {koshi:14, madhesh:8, bagmati:13, gandaki:11, lumbini:12, karnali:10, sudurpashchim:9};

const facts = [
  "Madhesh has <strong>8 districts</strong> but only <strong>32 seats</strong>. Pure population would give it <strong>~38 seats</strong>.",
  "Manang has just <strong>7,000 voters</strong> — yet sends 1 MP, same rights as Jhapa-5 with <strong>163,379 voters</strong>.",
  "On average, a Madhesh MP represents <strong>34,000 more voters</strong> than a Kathmandu MP.",
  "Constituencies were delimited on <strong>2068 census data</strong> and won't be reviewed for another <strong>16+ years</strong>.",
  "The 2048 general election was when Sadbhavana first raised <strong>equal constituency demand</strong> — still unresolved.",
  "With pure population weighting, Karnali province's <strong>12 seats</strong> would drop to just <strong>~9</strong>.",
  "53.61% of Nepal's population is in the Terai — but only <strong>47% of seats</strong> represent them.",
  "KP Oli's winning margin in Jhapa-5 alone exceeded the <strong>total voters</strong> of Kathmandu-1.",
];

let simState = {
  popWeight: 90,
  geoWeight: 10,
  minGuarantee: 1,
  teraiBias: 0,
};

let factIdx = 0;
let unrepTarget = 0;
let unrepCurrent = 0;

// ---- BUILD CURRENT REALITY CARDS ----
function buildCurrentCards() {
  const container = document.getElementById('currentCards');
  container.innerHTML = '';
  provinces.forEach((p, i) => {
    const votersPerSeat = Math.round(p.voters2082 / p.currentSeats);
    const nationalAvg = Math.round(TOTAL_VOTERS_2082 / TOTAL_SEATS);
    const ratio = (votersPerSeat / nationalAvg);
    const overrep = ratio < 1; // fewer voters per seat = overrepresented

    const card = document.createElement('div');
    card.className = 'province-card';
    card.style.setProperty('--card-color', p.color);
    card.style.animationDelay = `${i*0.07}s`;

    // Seat dots (max 33 shown)
    const dotsHTML = Array.from({length: Math.min(p.currentSeats, 40)}, (_, j) =>
      `<div class="seat-dot" style="background:${p.color}"></div>`
    ).join('');

    card.innerHTML = `
      <div class="pc-top">
        <div>
          <div class="pc-name">${p.name}</div>
          <div class="pc-region">${p.region}</div>
        </div>
        <div style="text-align:right">
          <div class="pc-seats" style="color:${p.color}">${p.currentSeats}</div>
          <div class="pc-seats-label">Seats</div>
        </div>
      </div>
      <div class="seat-dots">${dotsHTML}</div>
      <div class="pc-stats">
        <div class="pc-stat">
          <div class="pc-stat-val">${(p.voters2082/1e6).toFixed(2)}M</div>
          <div class="pc-stat-lbl">Voters 2082</div>
        </div>
        <div class="pc-stat">
          <div class="pc-stat-val">${votersPerSeat.toLocaleString()}</div>
          <div class="pc-stat-lbl">Voters/Seat</div>
        </div>
        <div class="pc-stat">
          <div class="pc-stat-val" style="color:${overrep?'#ff4060':'#3b82f6'}">${ratio.toFixed(2)}×</div>
          <div class="pc-stat-lbl">vs Avg Ratio</div>
        </div>
        <div class="pc-stat">
          <div class="pc-stat-val">${p.area.toLocaleString()} km²</div>
          <div class="pc-stat-lbl">Area</div>
        </div>
      </div>
    `;
    container.appendChild(card);
  });
}

// ---- CALCULATE SIMULATED SEATS ----
function calculateSimSeats(state) {
  const { popWeight, geoWeight, minGuarantee, teraiBias } = state;

  // Adjust voter counts with terai bias
  const adjustedVoters = provinces.map(p => {
    let v = p.voters2082;
    if (p.isTerai) v *= (1 + teraiBias/100);
    return v;
  });

  const totalAdjVoters = adjustedVoters.reduce((a,b) => a+b, 0);
  const totalArea = provinces.reduce((a,p) => a+p.area, 0);

  // Compute raw scores
  const popW = popWeight / 100;
  const geoW = geoWeight / 100;

  const scores = provinces.map((p, i) => {
    const popShare = adjustedVoters[i] / totalAdjVoters;
    const geoShare = p.area / totalArea;
    return popShare * popW + geoShare * geoW;
  });

  const totalScore = scores.reduce((a,b) => a+b, 0);

  // First pass: proportional seats
  let seats = scores.map(s => (s / totalScore) * TOTAL_SEATS);

  // Apply minimum guarantee
  const numDistricts = provinces.map(p => districtCount[p.id]);
  const minSeats = provinces.map((p,i) => minGuarantee * numDistricts[i]);

  // Enforce minimums
  let totalMin = minSeats.reduce((a,b) => a+b, 0);
  let remaining = TOTAL_SEATS - totalMin;

  const finalSeats = provinces.map((p,i) => {
    const proportional = Math.max(minSeats[i], seats[i]);
    return proportional;
  });

  // Normalize to exactly 165 using largest remainder
  const floored = finalSeats.map(s => Math.floor(s));
  const remainders = finalSeats.map((s,i) => ({ idx:i, rem:s - floored[i] }));
  let total = floored.reduce((a,b) => a+b, 0);
  let deficit = TOTAL_SEATS - total;
  remainders.sort((a,b) => b.rem - a.rem);
  for (let i=0;i<deficit;i++) floored[remainders[i].idx]++;

  return floored;
}

// ---- COMPUTE FAIRNESS INDEX ----
function computeFairness(simSeats) {
  const idealVotersPerSeat = TOTAL_VOTERS_2082 / TOTAL_SEATS;
  let totalVariance = 0;
  provinces.forEach((p,i) => {
    const actualVotersPerSeat = p.voters2082 / simSeats[i];
    const deviation = Math.abs(actualVotersPerSeat - idealVotersPerSeat) / idealVotersPerSeat;
    totalVariance += deviation * (p.voters2082 / TOTAL_VOTERS_2082);
  });
  const fairness = Math.max(0, Math.min(100, Math.round((1 - totalVariance) * 100)));
  return fairness;
}

// ---- COMPUTE UNREPRESENTED ----
function computeUnrep(simSeats) {
  const idealVotersPerSeat = TOTAL_VOTERS_2082 / TOTAL_SEATS;
  let unrep = 0;
  provinces.forEach((p,i) => {
    const votersPerSeat = p.voters2082 / simSeats[i];
    if (votersPerSeat > idealVotersPerSeat) {
      // excess voters beyond ideal
      const excessPerSeat = votersPerSeat - idealVotersPerSeat;
      const diluted = excessPerSeat * simSeats[i];
      unrep += diluted;
    }
  });
  return Math.round(unrep);
}

// ---- BUILD SIM CARDS ----
function buildSimCards(simSeats) {
  const container = document.getElementById('simCards');
  container.innerHTML = '';

  const maxSeats = Math.max(...provinces.map(p=>p.currentSeats), ...simSeats);

  provinces.forEach((p,i) => {
    const sim = simSeats[i];
    const delta = sim - p.currentSeats;
    const isGaining = delta > 0;
    const isLosing = delta < 0;
    const wouldDrop = sim === 0;

    const card = document.createElement('div');
    card.className = `sim-card ${isGaining?'gaining':''} ${isLosing?'losing':''} ${wouldDrop?'would-drop':''}`;
    card.style.animationDelay = `${i*0.05}s`;

    const currentPct = (p.currentSeats / maxSeats * 100).toFixed(0);
    const simPct = (sim / maxSeats * 100).toFixed(0);

    const deltaStr = delta === 0 ? '±0' : (delta > 0 ? `+${delta}` : `${delta}`);
    const deltaColor = delta > 0 ? 'var(--gain)' : delta < 0 ? 'var(--loss)' : 'var(--text-dim)';

    card.innerHTML = `
      <div class="sim-card-top">
        <div>
          <div class="sim-pname">${p.name}</div>
          <div style="font-family:var(--font-mono);font-size:8px;color:var(--text-dim);margin-top:2px;">${p.region} · ${districtCount[p.id]} districts</div>
        </div>
        <div style="text-align:right">
          <div class="sim-change" style="color:${deltaColor}">${deltaStr}</div>
          <div style="font-family:var(--font-mono);font-size:9px;color:var(--text-dim);">${p.currentSeats} → <strong style="color:${deltaColor}">${sim}</strong></div>
        </div>
      </div>
      <div class="sim-bars">
        <div style="flex:1;display:flex;flex-direction:column;justify-content:flex-end;gap:2px">
          <div style="font-family:var(--font-mono);font-size:7px;color:var(--neutral);">Current: ${p.currentSeats}</div>
          <div class="sim-bar-current" style="height:${currentPct}%;background:${p.color}44;border:1px solid ${p.color}66;"></div>
        </div>
        <div style="flex:1;display:flex;flex-direction:column;justify-content:flex-end;gap:2px">
          <div style="font-family:var(--font-mono);font-size:7px;color:${deltaColor};">Simulated: ${sim}</div>
          <div class="sim-bar-fair" style="height:${simPct}%;background:${deltaColor}33;border:1px solid ${deltaColor}66;"></div>
        </div>
        <div style="flex:3;display:flex;flex-direction:column;justify-content:flex-end;padding-left:8px">
          <div style="font-family:var(--font-mono);font-size:8px;color:var(--text-dim);margin-bottom:3px;">${p.notableConst}</div>
          <div style="font-family:var(--font-mono);font-size:8px;color:var(--text-dim);">
            ${Math.round(p.voters2082/sim).toLocaleString()} voters/seat (new)
          </div>
        </div>
      </div>
      ${wouldDrop ? '<div class="below-threshold">⚠ BELOW 1-SEAT THRESHOLD</div>' : ''}
    `;
    container.appendChild(card);
  });
}

// ---- UPDATE SUMMARY ----
function updateSummary(simSeats) {
  const fairness = computeFairness(simSeats);
  const unrep = computeUnrep(simSeats);

  let gained = 0, lost = 0, drop = 0;
  provinces.forEach((p,i) => {
    const d = simSeats[i] - p.currentSeats;
    if (d > 0) gained += d;
    if (d < 0) lost += Math.abs(d);
    if (simSeats[i] === 0) drop++;
  });

  animateNum('sumGained', `+${gained}`);
  animateNum('sumLost', `−${lost}`);
  animateNum('sumDrop', drop);
  animateNum('sumFair', fairness + '%');

  // Fairness bar
  document.getElementById('fairnessFill').style.width = fairness + '%';
  const fscore = document.getElementById('fairnessScore');
  fscore.textContent = fairness + '%';
  fscore.style.color = fairness > 70 ? 'var(--gain)' : fairness > 50 ? 'var(--accent)' : 'var(--loss)';

  // Unrepresented
  unrepTarget = unrep;
  document.getElementById('unrepDetail').textContent = unrep.toLocaleString();
  const reduction = Math.round((1 - unrep / 8500000) * 100);
  document.getElementById('unrepText').innerHTML = `
    <strong style="color:var(--loss)">${unrep.toLocaleString()}</strong> voters whose electoral weight is below national average.<br/>
    This formula reduces dilution by <strong style="color:var(--gain)">${Math.max(0,reduction)}%</strong> vs current system.
  `;
}

function animateNum(id, val) {
  const el = document.getElementById(id);
  if (el.textContent !== String(val)) {
    el.textContent = val;
    el.classList.remove('counting');
    void el.offsetWidth;
    el.classList.add('counting');
  }
}

// ---- HEARTBEAT COUNTER ----
function updateUnrepCounter() {
  const current = parseInt(document.getElementById('unrepCount').textContent.replace(/,/g,'')) || 0;
  const diff = unrepTarget - current;
  const step = diff > 0 ? Math.ceil(diff / 20) : Math.floor(diff / 20);
  const next = diff === 0 ? current : current + step;
  document.getElementById('unrepCount').textContent = next.toLocaleString();

  // Heartbeat SVG
  drawHeartbeat(next);
}

function drawHeartbeat(val) {
  const line = document.getElementById('heartbeatLine');
  const norm = Math.min(val / 10000000, 1);
  const pts = [];
  for (let x=0; x<=180; x+=6) {
    const phase = (x / 180) * Math.PI * 6;
    const spike = x > 70 && x < 90 ? Math.sin((x-70)/20*Math.PI)*20*norm : 0;
    const base = Math.sin(phase)*3*norm;
    const y = 20 - base - spike;
    pts.push(`${x},${y}`);
  }
  line.setAttribute('points', pts.join(' '));
}

// ---- RECALCULATE ALL ----
function recalculate() {
  const simSeats = calculateSimSeats(simState);
  buildSimCards(simSeats);
  updateSummary(simSeats);
}

// ---- SLIDERS ----
document.getElementById('popWeight').addEventListener('input', function() {
  simState.popWeight = parseInt(this.value);
  document.getElementById('popVal').textContent = this.value + '%';
  document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
  recalculate();
});

document.getElementById('geoWeight').addEventListener('input', function() {
  simState.geoWeight = parseInt(this.value);
  document.getElementById('geoVal').textContent = this.value + '%';
  document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
  recalculate();
});

document.getElementById('minGuarantee').addEventListener('input', function() {
  simState.minGuarantee = parseInt(this.value);
  document.getElementById('minVal').textContent = this.value;
  document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
  recalculate();
});

document.getElementById('teraiBias').addEventListener('input', function() {
  simState.teraiBias = parseInt(this.value);
  document.getElementById('teraiBiasVal').textContent = this.value + '%';
  document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
  recalculate();
});

// ---- PRESETS ----
const presets = {
  current: { popWeight:90, geoWeight:10, minGuarantee:1, teraiBias:0 },
  pure_pop: { popWeight:100, geoWeight:0, minGuarantee:0, teraiBias:0 },
  madhesh_demand: { popWeight:100, geoWeight:0, minGuarantee:1, teraiBias:15 },
  geo_heavy: { popWeight:60, geoWeight:40, minGuarantee:1, teraiBias:0 },
  voter_based: { popWeight:95, geoWeight:5, minGuarantee:1, teraiBias:5 },
};

function applyPreset(name) {
  const p = presets[name];
  simState = {...p};

  document.getElementById('popWeight').value = p.popWeight;
  document.getElementById('geoWeight').value = p.geoWeight;
  document.getElementById('minGuarantee').value = p.minGuarantee;
  document.getElementById('teraiBias').value = p.teraiBias;

  document.getElementById('popVal').textContent = p.popWeight + '%';
  document.getElementById('geoVal').textContent = p.geoWeight + '%';
  document.getElementById('minVal').textContent = p.minGuarantee;
  document.getElementById('teraiBiasVal').textContent = p.teraiBias + '%';

  document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');

  recalculate();
}

// ---- FACT TICKER ----
function nextFact() {
  const el = document.getElementById('bottomFact');
  el.style.opacity = '0';
  setTimeout(() => {
    el.innerHTML = facts[factIdx % facts.length];
    el.style.opacity = '1';
    factIdx++;
  }, 300);
}

// ---- INIT ----
buildCurrentCards();
recalculate();
nextFact();

setInterval(updateUnrepCounter, 80);
setInterval(nextFact, 6000);
</script>
</body>
</html>